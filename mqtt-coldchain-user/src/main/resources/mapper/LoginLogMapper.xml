<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coldchain.user.mapper.LoginLogMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.coldchain.user.entity.LoginLog">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="real_name" property="realName"/>
        <result column="status" property="status"/>
        <result column="failure_reason" property="failureReason"/>
        <result column="ip" property="ip"/>
        <result column="location" property="location"/>
        <result column="user_agent" property="userAgent"/>
        <result column="browser" property="browser"/>
        <result column="os" property="os"/>
        <result column="login_time" property="loginTime"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, tenant_id, user_id, username, real_name, status, failure_reason, ip, location,
        user_agent, browser, os, login_time
    </sql>

    <!-- 插入登录日志 -->
    <insert id="insert" parameterType="com.coldchain.user.entity.LoginLog">
        INSERT INTO login_log (
            tenant_id, user_id, username, real_name, status, failure_reason, ip, location,
            user_agent, browser, os, login_time
        ) VALUES (
            #{tenantId}, #{userId}, #{username}, #{realName}, #{status}, #{failureReason},
            #{ip}, #{location}, #{userAgent}, #{browser}, #{os}, #{loginTime}
        )
    </insert>

    <!-- 查询登录日志列表（自动过滤租户） -->
    <select id="selectList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM login_log
        WHERE tenant_id = #{tenantId}
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="startTime != null">
            AND login_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND login_time &lt;= #{endTime}
        </if>
        ORDER BY login_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
        <if test="offset != null">
            OFFSET #{offset}
        </if>
    </select>

    <!-- 统计登录失败次数 -->
    <select id="countLoginFail" resultType="int">
        SELECT COUNT(*)
        FROM login_log
        WHERE tenant_id = #{tenantId}
        AND user_id = #{userId}
        AND status = 0
        AND login_time &gt;= #{startTime}
    </select>

</mapper>
